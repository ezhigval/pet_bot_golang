User Service – расширенная логика регистрации и защиты
1. Основные сущности базы данных
   Таблица: users

id – уникальный идентификатор пользователя

email – уникальный email

phone – уникальный телефон (опционально)

password_hash – хэш пароля (bcrypt/argon2)

created_at – дата создания

updated_at – дата обновления

2fa_enabled – флаг включения 2FA

is_suspicious – флаг подозрительной регистрации

subscription_status – free / paid / trial

trial_period_end – дата окончания пробного периода

last_login – дата последнего входа

Таблица: devices

id – уникальный идентификатор устройства

user_id – ссылка на users.id

device_fingerprint – уникальный идентификатор устройства

created_at – дата первой привязки

last_used_at – дата последнего использования

is_active – флаг активного устройства

Таблица: registrations_log

id – уникальный идентификатор записи

email – email при регистрации

device_fingerprint – идентификатор устройства

ip_address – IP пользователя

created_at – дата регистрации

attempt_number – порядковый номер попытки регистрации с этого устройства

alert_sent – флаг отправки администратору

2. Логика регистрации

Пользователь вводит email/телефон и пароль.

Система проверяет:

Есть ли уже аккаунт с этим email/телефоном → если да, предлагает войти.

Есть ли привязка этого устройства → если да:

Сообщение пользователю:
"На данном устройстве уже был зарегистрирован аккаунт. Войти в существующий аккаунт?"

Возможность выбрать:

Да → перенаправить на вход.

Нет, создать новый → создаётся новый аккаунт с сокращённым пробным периодом (например, 7 дней вместо 14) и увеличивается attempt_number в registrations_log.

Если attempt_number достигает 3 → блокируем создание бесплатного аккаунта с этого устройства, оставляем возможность только для платной подписки.

При каждой подозрительной регистрации → отправляем алерт разработчикам/администраторам.

3. Логика уведомлений

Если старый аккаунт на этом устройстве активен → присылаем уведомление о возможности покупки подписки с небольшой скидкой.

Это повышает лояльность и одновременно снижает пиратство.

4. Привязка к устройствам и IP

Устройство привязывается к аккаунту при первой регистрации.

Одно устройство может иметь несколько привязанных аккаунтов, но ограничено правилами выше (например, 3 попытки бесплатного периода).

IP используется для мониторинга массовых регистраций с одного адреса → предупреждение о подозрительных регистрациях.

5. 2FA и безопасность

После успешного ввода email/пароля пользователь проходит проверку 2FA.

JWT выдаётся только после прохождения 2FA.

Device fingerprint + IP + 2FA → основа защиты от взлома и обхода ограничений.

6. Поведение при подозрительных регистрациях (алгоритм)

Регистрация с известного устройства → attempt_number += 1

Если attempt_number == 1 → сокращённый пробный период, уведомление администратору

Если attempt_number == 2 → сокращённый пробный период, уведомление администратору

Если attempt_number >= 3 → блокируем бесплатный аккаунт, рекомендуем подписку

Старые аккаунты → уведомление о скидке на подписку

7. API User Service (мини-подсказка)

POST /register → регистрация + логика сокращённого пробного периода + 2FA

POST /login → вход с 2FA + JWT

POST /verify-2fa → проверка кода 2FA

GET /user/me → получение данных пользователя

POST /devices → привязка нового устройства

GET /alerts → уведомления о подозрительной активности (для администраторов)